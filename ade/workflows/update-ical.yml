name: Update iCal to JSON


on:
workflow_dispatch:
inputs:
force:
description: "Force un commit même sans différence (debug)"
required: false
default: "false"
schedule:
- cron: '*/30 * * * *' # toutes les 30 minutes (UTC)


permissions:
contents: write


concurrency:
group: update-ical
cancel-in-progress: true


env:
ICS_URL: ${{ vars.ICS_URL || secrets.ICS_URL }}
TZ: Europe/Paris


jobs:
build:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v4
with:
fetch-depth: 0


- name: Setup Node
uses: actions/setup-node@v4
with:
node-version: '20'


- name: Install deps
run: |
npm ci || npm i


- name: Generate latest.json
run: |
npm run generate


- name: Commit if changed
run: |
if [ "${{ github.event.inputs.force }}" = "true" ]; then
echo "forced $(date -u +%FT%TZ)" > data/.force.txt
git add data/.force.txt
fi


git config user.name "github-actions[bot]"
git config user.email "41898282+github-actions[bot]@users.noreply.github.com"


git add data/latest.json
if git diff --quiet --staged; then
echo "No changes to commit."
exit 0
else
git commit -m "Update latest.json ($(date -u +%FT%TZ))"
git push
fi
